@(searchForm: Form[Query], query: Query, answers: AnswerSet, filters: Set[TypeFilter], pageno: Int, pageCount: Int, maxSentenceCount: Int)

@import helper.twitterBootstrap._
@import edu.washington.cs.knowitall.browser.extraction.ExtractionGroup

@helper.main("UW Open Information Extraction") {
  <style>
    .hid { display: none }
    .title-entity { font-weight: bold }
    .answer { font-size: large }
    .popover-image {
      float: left;
      border: 1px solid;
      margin: 5px;
    }
    .close-tab {
      float: right
    }
  </style>
  
  @helper.form(action = routes.Application.submit, 'class -> "well form-inline") {
      <label for="arg1">Argument 1:</label>
      <span class="input">
          <input type="text" id="arg1" name="arg1" value="@query.arg1" >
          <span class="help-inline"></span>
      </span>
      <label for="rel">Relation:</label>
      <span class="input">
          <input type="text" id="rel" name="rel" value="@query.rel" >
          <span class="help-inline"></span>
      </span>
      <label for="arg2">Argument 2:</label>
      <span class="input">
          <input type="text" id="arg2" name="arg2" value="@query.arg2" >
          <span class="help-inline"></span>
      </span>
      <button class="btn primary"><i class="icon-search"></i> Search</button>
  }
  
  <div id="stats"><b>@answers.answerCount answers</b> from <b>@answers.sentenceCount sentences</b></div>


  <b>Types:</b> 
  <span id="types">
@for((filter, count)<-answers.filters.sortBy(-_._2)) {
  @defining(filters.contains(filter)) { active =>
    <button id="type-@filter.typ.name" href="foo" class="btn btn-primary @{if(active) "active" else ""}" data-toggle="button" onclick="window.location.href='@{routes.Application.search(query.arg1.map(_.toString), query.rel.map(_.toString), query.arg2.map(_.toString), (if (active) filters - filter else filters + filter).iterator.map(_.typ.name).mkString(","), 0)}'">@filter.displayName (@count)</button>
  }
}
  </span>

  <div style="height: 25px"></div>

  <div class="tabbable tabs-left">
    <ul class="nav nav-tabs">
      @for((g, i) <- answers.groups.zipWithIndex) {
      <li><a href="#L@{i}" class="answer" data-toggle="tab">@helper.grouptitle(g.title) (@g.contents.size)</a></li>
      }
    </ul>
    <div class="tab-content">
      @for((g, i) <- answers.groups.zipWithIndex) {
      <div class="tab-pane" id="L@{i}">
        <span class="close-tab"><a href="#close@{i}" class="close-tab" title="close sentences"><i class="icon-remove"></i></a></span>
        @helper.sentences(g.copy(contents=g.contents.take(maxSentenceCount)))
        @if(g.contents.size > maxSentenceCount) {
          <p style="text-align: center"><a href="@{routes.Application.sentences(query.arg1.map(_.toString), query.rel.map(_.toString), query.arg2.map(_.toString), g.title.text)}">Show all sentences (@{g.contents.size - maxSentenceCount} more)</a></p>
        }
      </div>
      }
    </div>
  </div> <!-- /tabbable -->
    <!-- Pagination -->
    <div class="pagination" align="center">
        <ul>
@if(pageno > 0) {
            <li><a href="@{routes.Application.search(query.arg1.map(_.toString), query.rel.map(_.toString), query.arg2.map(_.toString), "", pageno - 1)}">Prev</a></li>
}
@for(i <- pageno-4 to pageno-1; if i >= 0) {
            <li><a href="@{routes.Application.search(query.arg1.map(_.toString), query.rel.map(_.toString), query.arg2.map(_.toString), "", i)}">@i</a></li>
}
            <li class="active">
            <a href="#">@pageno</a>
            </li>
@for(i <- pageno+1 to pageno+4; if i < pageCount) {
            <li><a href="@{routes.Application.search(query.arg1.map(_.toString), query.rel.map(_.toString), query.arg2.map(_.toString), "", i)}">@i</a></li>
}
@if(pageno + 1 < pageCount) {
            <li><a href="@{routes.Application.search(query.arg1.map(_.toString), query.rel.map(_.toString), query.arg2.map(_.toString), "", pageno + 1)}">Next</a></li>
}
        </ul>
    </div>
  
    <script type="text/javascript">
    $.extend({
  getUrlVars: function(){
    var vars = [], hash;
    var hashes = window.location.href.slice(window.location.href.indexOf('?') + 1).split('&');
    for(var i = 0; i < hashes.length; i++)
    {
      hash = hashes[i].split('=');
      vars.push(hash[0]);
      vars[hash[0]] = hash[1];
    }
    return vars;
  },
  getUrlVar: function(name){
    return $.getUrlVars()[name];
  }
});

      var download_popover = function() {
        // this refers to a different object in 
        // a nested anonymous function
        var span = this

        // we don't want to run this particular action again,
        // but we don't want to remove all hover actions
        $(span).unbind('hover', download_popover)

        $.getJSON("https://www.googleapis.com/freebase/v1/text/m/"+span.id+'?format=plain&lang=en&maxlength=200&callback=?', function(response) {
          var src = 'https://usercontent.googleapis.com/freebase/v1/image/m/'+span.id+'?maxheight=75&maxwidth=75'
          $(span).attr('data-content', function(index, attr) { 
            return '<img class="popover-image" src="'+src+'">' + '<span class="popover-desc">'+response.result+"</span>" + '<div style="height: 10px"></div>'+attr
          })

          var image = new Image()
          image.src = src
        })
      }

      $('.title-string').popover({ delay: { show: 1000, hide: 100 }})

      $('.title-entity').popover({ delay: { html: true, show: 1000, hide: 100 }})
      $('.title-entity').hover(download_popover)

      $('.close-tab').click(function() {
        var $active = $('.tab-content').find('> .active')
        $active.removeClass('active')
      })
    </script>
}
